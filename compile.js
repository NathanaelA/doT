// Generated by CoffeeScript 1.4.0
(function() {
  var argv, asyncAfterAll, asyncCalls, asyncDone, asyncStarted, doT, fs, path, readFile, readItem;

  fs = require('fs');

  path = require('path');

  doT = require('./doT.js');

  asyncCalls = 0;

  asyncAfterAll = function() {
    return process.stdout.write(doT.exportCached());
  };

  asyncStarted = function() {
    return asyncCalls += 1;
  };

  asyncDone = function() {
    asyncCalls -= 1;
    if (0 === asyncCalls) {
      return asyncAfterAll();
    }
  };

  readItem = function(item) {
    asyncStarted();
    return fs.stat(item, function(err, stat) {
      if (err) {
        process.stderr.write(err);
      } else if (stat.isDirectory()) {
        asyncStarted();
        fs.readdir(item, function(err, files) {
          if (err) {
            process.stderr.write(err);
          } else {
            files.forEach(function(file) {
              return readItem(path.join(item, file));
            });
          }
          return asyncDone();
        });
      } else {
        readFile(item);
      }
      return asyncDone();
    });
  };

  readFile = function(file) {
    asyncStarted();
    return fs.readFile(file, function(err, data) {
      var f, id, rel;
      if (err) {
        process.stderr.write("Error reading file '" + file + "': '" + err + "\n");
      } else {
        id = path.basename(file, path.extname(file));
        if (argv.base) {
          rel = path.relative(argv.base, path.dirname(file)).replace(/\//g, '.');
          if (rel) {
            id = "" + rel + "." + id;
          }
        }
        try {
          f = doT.compile(data);
          doT.addCached(id, f);
        } catch (err) {
          process.stderr.write("Error compiling file '" + file + "': '" + err + "'\n");
        }
      }
      return asyncDone();
    });
  };

  argv = require('optimist')["default"]({
    base: ''
  }).alias({
    base: 'b'
  }).argv;

  argv._.forEach(function(val, i) {
    return readItem(val);
  });

}).call(this);
